name: Deploy to VPS (Blue-Green)

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: lehuyvuuu/capstone-backend
  APP_NAME: capstone-backend
  BLUE_PORT: 5224
  GREEN_PORT: 5225
  CONTAINER_PORT: 5224
  UPSTREAM_FILE: /etc/nginx/snippets/capstone-upstream.conf
  ENV_DIR: /root/capstone
  HEALTH_PATH: /api/health

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max

      - name: Deploy to VPS (Blue-Green switch)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            set -euo pipefail

            echo "ðŸ” Docker login"
            echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            echo "ðŸ§¾ Write env file"
            sudo mkdir -p ${{ env.ENV_DIR }}
            sudo tee ${{ env.ENV_DIR }}/.env > /dev/null <<'EOF'
            ${{ secrets.ENV_FILE }}
            EOF

            echo "ðŸ“¥ Pull image"
            docker pull ${{ env.DOCKER_IMAGE }}:latest

            # Determine current active port by reading upstream file if exists
            ACTIVE_PORT=""
            if sudo test -f "${{ env.UPSTREAM_FILE }}"; then
              ACTIVE_PORT=$(sudo grep -Eo '127\.0\.0\.1:[0-9]+' "${{ env.UPSTREAM_FILE }}" | head -n1 | cut -d: -f2 || true)
            fi

            if [[ "$ACTIVE_PORT" == "${{ env.BLUE_PORT }}" ]]; then
              NEW_COLOR="green"
              OLD_COLOR="blue"
              NEW_PORT="${{ env.GREEN_PORT }}"
              OLD_PORT="${{ env.BLUE_PORT }}"
            elif [[ "$ACTIVE_PORT" == "${{ env.GREEN_PORT }}" ]]; then
              NEW_COLOR="blue"
              OLD_COLOR="green"
              NEW_PORT="${{ env.BLUE_PORT }}"
              OLD_PORT="${{ env.GREEN_PORT }}"
            else
              # First deploy (no upstream yet) -> choose green as default
              NEW_COLOR="green"
              OLD_COLOR="blue"
              NEW_PORT="${{ env.GREEN_PORT }}"
              OLD_PORT="${{ env.BLUE_PORT }}"
            fi

            echo "ðŸ”µðŸŸ¢ Blue-Green"
            echo "Active port: ${ACTIVE_PORT:-none}"
            echo "Deploying: $NEW_COLOR on port $NEW_PORT (old $OLD_COLOR on $OLD_PORT)"

            # Clean any existing NEW_COLOR container
            docker stop ${{ env.APP_NAME }}-$NEW_COLOR 2>/dev/null || true
            docker rm   ${{ env.APP_NAME }}-$NEW_COLOR 2>/dev/null || true

            echo "ðŸš€ Run new container"
            docker run -d \
              --name ${{ env.APP_NAME }}-$NEW_COLOR \
              --restart unless-stopped \
              -p 127.0.0.1:$NEW_PORT:${{ env.CONTAINER_PORT }} \
              -e ASPNETCORE_URLS=http://+:${{ env.CONTAINER_PORT }} \
              --env-file ${{ env.ENV_DIR }}/.env \
              ${{ env.DOCKER_IMAGE }}:latest

            echo "â³ Health check http://127.0.0.1:$NEW_PORT${{ env.HEALTH_PATH }}"
            for i in {1..30}; do
              if curl -fsS "http://127.0.0.1:$NEW_PORT${{ env.HEALTH_PATH }}" >/dev/null; then
                echo "âœ… New container healthy"
                break
              fi
              echo "Attempt $i/30: not ready..."
              sleep 2
            done

            if ! curl -fsS "http://127.0.0.1:$NEW_PORT${{ env.HEALTH_PATH }}" >/dev/null; then
              echo "âŒ Health check failed. Rollback."
              docker logs --tail 200 ${{ env.APP_NAME }}-$NEW_COLOR || true
              docker stop ${{ env.APP_NAME }}-$NEW_COLOR || true
              docker rm   ${{ env.APP_NAME }}-$NEW_COLOR || true
              exit 1
            fi

            echo "ðŸ” Switch Nginx upstream (atomic)"
            sudo mkdir -p /etc/nginx/snippets
            sudo tee "${{ env.UPSTREAM_FILE }}.tmp" > /dev/null <<EOF
            upstream capstone_backend {
                server 127.0.0.1:$NEW_PORT;
            }
            EOF
            sudo mv "${{ env.UPSTREAM_FILE }}.tmp" "${{ env.UPSTREAM_FILE }}"

            sudo nginx -t
            sudo systemctl reload nginx
            echo "âœ… Nginx now points to $NEW_PORT"

            echo "ðŸ§¯ Stop old container after switch"
            if docker ps -q --filter "name=^${{ env.APP_NAME }}-$OLD_COLOR$" | grep -q .; then
              docker stop ${{ env.APP_NAME }}-$OLD_COLOR || true
              docker rm   ${{ env.APP_NAME }}-$OLD_COLOR || true
            fi

            echo "ðŸ§½ Cleanup old images"
            docker image prune -af --filter "until=48h" || true

            echo "ðŸŽ‰ Done. Active: $NEW_COLOR ($NEW_PORT)"
